# Механики

## Игровая прогрессия

Игрок может повышать уровни. С каждым уровнем повышается здоровье, энергия и урон.
Опыт может быть потерян с некоторым шансом входящим уроном, а также может быть потрачен на
улучшения, способности и вооружение в магазине.

Лимита по максимальному уровню нет, но прибавки к характеристикам на высоких уровнях начинают стремиться
к нулю. Уровень является главным показателем игрока, и таблица игроков сортируется по его уровню.

Уровень повышается сбором опыта. Опыт выпадат из астероидов:

- небольшое количество с некоторым шансом при уроне от вооружения игрока (в зависимости от процентного
  соотношения поступающего урона от максимального здоровья астероида)
- при смерти астероида от вооружения игрока. Урон от окружающей среды (например от столкновений) не
  должен вызывать выпадение опыта.

Таже опыт выпадает из погибших игроков в размере 30% от накопленного.

Выпавший опыт пропадает через небольшой промежуток времени. Чем меньше времени осталось до исчезновения,
тем меньше опыта возможно будет подобрать (линейная зависимость). Гранулы опыта визуально меньшаются
в размерах.

Шкала уровня в интерфейсе выглядит как белая полоса снизу экрана во всю ширину с небольшим отсупом
от границ. Посередине цифра текущего уровня. (нужно где-то разместить текущее количество опыта и
необходимое количество для следующего уровня)

## Характеристики, способности и арсенал

### Характеристики

Энергия игрока используется на применение некоторого вооружения, способностей, а также тратится
при получении урона, защищая игрока от входящего урона.

- здоровье
- энергия

- скорость восполнения здоровья
- скорость восполнения энергии

- сопротивление урону здоровьем (броня)
- сопротивление урону энергией (щиты)

- ускорение
- обратное ускорение

Обратное ускорение влияет на скорость торможения (при полете задом-наперед со включенными двигатеолями)
Скорость торможения зависит как от значения обратного ускорения, так и от угла корабля относительно
текущего направления движения.

### Способности

- Энергощит. Тратит 40% энергии и защищает от любого входящего спереди корабля урона на 300мс

### Арсенал

- Обычные пули. Тратят энергию при выстреле

## Интерфейс

Если на радаре видны другие игроки, на краю экрана появляется красная стрелка в их направлении
со значением расстояния (и относительной скорости). Если другой игрок на экране, стрелка пропадает

Если по направлению движения игрока на расстоянии действия радара есть объект, с которым произойдет
столкновение, если не изменить траекторию, в направлении такого объекта на краю экрана появляется
красная стрелка с восклицательным знаком. Стрелка не появляется, если относительная скорость игрока
и объекта достаточно низкая. Стрелка также появляется, объект на большой скоростью летит на игрока,
тогда как игрок стоит на месте.

## Игровые события

### Прилет кометы

С края карты прилетает комета и летит сквозь уровень. Имеет много здоровья, но при уничтожении дает
много опыта. Комета всегда отображается на радаре. Цель события - привлечь игроков в одну зону для
борьбы за ресурсы

### Появление космического трейдера

Иногда на карте может появиться корабль космического торговца. Он продает некоторый набор улучшений,
вооружения и предметов. Предметы конечны. Торговец улетает после продажи всех вещей, либо по истечении
таймера. Если торговца атаковать, он прекратит продажу, начнет атаковать в ответ и после завершения
нападения улетит. При убийстве торговца из него могут выпасть некоторые товары, которые он продавал.
У торговца достаточно мощный щит и вооружение, так что в одиночку его вряд ли получится уничтожить.

### Появление черной дыры

Иногда через карту может пролететь небольшая черная дыра. она будет притягивать к себе и уничтожать
все, что оказажется поблизости. Может раскидать астероиды рядом в игроков, оказавшихся неподалеку.
Искривляет все, в том числе траекторию пуль и лазерное вооружение

## Экшены и события (тех)

Когда Актору поступает экшен при обработке конкретного, тот сначала вызывает соответствующее событие.
Если событие не было отменено подписчиком, происходит стандартная логика
Например, поступил экшен урона. Код вызывает событие урона. Это событие могут кто-то из подписчиков
изменить или отменить. После этого, если событие не отменили, происходит стандартная логика нанесения
урона с измененными после подписчиков значениями урона из события.

## Здоровье и энергия

У большинства физических объектов есть показатель здоровья. У кораблей также есть энергия.
Энергия восстанавливается со временем и тратится на любые взадействия - ускорение, выстрелы
бесконечным вооружением, получение урона.

При получении урона сначала тратится энергия. Если ее не хватает для поглощения урона, то
остаток отнимается от здоровья.

### Броня и сопротивление энергетического щита

У корабля также есть два раздельных показателя сопротивления урона для здоровья и для энергии.
Первое называется показателем сопротивления брони, второе - сопротивлением энергетического щита:

- Значение в единицу означает отсутствие влияния
- Значение больше единицы - повышенное сопротивление урону
- Значение меньше единицы - пониженное сопротивление урону

У любого вооружения помимо параметра урона есть раздельные параметры пробития брони и щита:

- Значение в единицу означает отсутствие влияния.
- значение больше единицы - повышенное влияние.
- значение меньше единицы - пониженное влияние.

### Механика расчета получаемого урона

#### Исходные данные

```ts
let Sh = 100; // здоровье корабля
let Sp = 25; // энергия корабля
let Ssr = 0.9; // сопротивление уровну для щита
let Shr = 1.1; // сопротивление урону для здоровья

let D = 50; // входящий урон
let Dsp = 1; // коэффициент пробития щитов
let Dhp = 1.2; // коэффициент пробития брони
```

#### Первый вариант расчета

```ts
let shieldDamage = Math.max(0, (D * Dsp) / Ssr);
let powerAfterDamage = Sp - shieldDamage;

Sp = Math.max(0, powerAfterDamage);

let damageAfterShield = 0 - powerAfterDamage;
if (damageAfterShield <= 0) {
  return;
}

let healthDamage = (damageAfterShield * Dhp) / Shr;
let healthAfterDamage = Sh - healthDamage;

Sh = healthAfterDamage;
```

Преимущества:

- Предсказуемый расчет урона

Недостатки:

- Оператор деления в операциях (дорогостоящая операция)

#### Второй вариант расчета

```ts
let modifiedShieldValue = Sp * Ssr - D * Dsp;
let shieldAfterDamage = Math.min(Sp, modifiedShieldValue);

Sp = Math.max(0, shieldAfterDamage);

let damageAfterShield = 0 - shieldAfterDamage;
if (damageAfterShield <= 0) {
  return;
}

let modifiedHealthValue = Sh * Shr - damageAfterShield * Dhp;
let healthAfterDamage = Math.min(Sh, modifiedHealthValue);

Sh = healthAfterDamage;
```

Преимущества:

- Более оптимизированная логика расчета

Недостатки:

- В некоторых условиях значение урона может стать отрицательным,
  поэтому следует убедиться, что подобный урон не применитя

## Экран заставки

Показывать логотип The Orange Line Studios пока идет загрузка. Можно показывать логотип как минимум
0.5 - 1 секунду, чтобы сразу после начиналась игра.

Вероятно в любом случае потребуется перед началом игры давать необходимость игроку куда-то нажать.
Иначе не запустятся звуки в браузере.

## Возможные сопособы обработки ИИ пиратов

### Логика ии (таймер со скоростью 100-300мс) обрабатывается только на сервере.

Минусы:

- на сервере потребуется держать как можно более актуальную информацию обо всех объектах,
  чтобы ии мог правильно определять свою цель

### Логика ии обрабатывается ближайшим игроком. Каждый цикл ии таймера проверяется ближайший игрок и при необходимости хост передается ему

### Логика ии обрабатывается текущей или последней целью пирата

## Вероятные методы дальнейшей оптимизации

Если объект не на экране и является репликой, можно:

- уменьшить для него скорость обновления (пропускать вызовы postupdate)
- обновлять его состояние из приходящих сообщений не чаще 500-1000мс
- упростить логику (например не обрабатывать столкновения)
- не исполнять логику погашения сетевой задержки (всегда передавать latency 0)

Если игрок является хостом объекта:

- уменьшить для него скорость обновления (пропускать вызовы postupdate)
- упростить логику (например не обрабатывать столкновения) (нужно убедиться при этом что объект не
  находится в поле зрения другого игрока)
- если объект ближе к другому игроку, передавать хост ему и применять оптимизации для объектов реплик

Как вариант также можно передавать обработку таких объектов на сервер. Придется создавать на сервере
минимально работоспособный игровой таймер с обсчетом позиций и скорости объектов. Подобный цикл может
быть достаточно медленным - 250-500мс или больше. Вероятно, в таком случае следует вообще удалять эти
объекты у игроков и снова создавать у них при приближении к области видимости.
